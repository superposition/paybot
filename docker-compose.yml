services:
  # Hardhat blockchain node
  hardhat-node:
    build:
      context: .
      dockerfile: packages/contracts/Dockerfile
    container_name: paybot-hardhat
    ports:
      - "${ANVIL_PORT:-8545}:8545"
    environment:
      - CHAIN_ID=${ANVIL_CHAIN_ID:-31337}
    networks:
      - paybot-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://0.0.0.0:8545"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    volumes:
      - contracts-data:/app/packages/contracts/deployments
      - ./packages/contracts/artifacts:/app/packages/contracts/artifacts
      - contract-exports:/app/apps/web/src/contracts
    command: bun run node:deploy

  # X402 Facilitator (payment verification and settlement)
  x402-facilitator:
    build:
      context: .
      dockerfile: apps/x402-facilitator/Dockerfile
    container_name: paybot-facilitator
    ports:
      - "${X402_FACILITATOR_PORT:-8403}:8403"
    environment:
      - X402_FACILITATOR_PORT=${X402_FACILITATOR_PORT:-8403}
      - VITE_RPC_URL=http://hardhat-node:8545
      - VITE_CHAIN_ID=${ANVIL_CHAIN_ID:-31337}
      - VITE_QUSD_TOKEN_ADDRESS=${QUSD_TOKEN_ADDRESS}
      - VITE_ESCROW_CONTRACT_ADDRESS=${ESCROW_CONTRACT_ADDRESS}
      - FACILITATOR_PRIVATE_KEY=${ANVIL_ACCOUNT_0_PRIVATE_KEY}
    networks:
      - paybot-network
    depends_on:
      hardhat-node:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://0.0.0.0:8403/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    volumes:
      - contracts-data:/app/packages/contracts/deployments:ro

  # Example Resource Server (demonstrates X402 middleware)
  resource-server:
    build:
      context: .
      dockerfile: apps/x402-facilitator/Dockerfile
    container_name: paybot-resource-server
    ports:
      - "${RESOURCE_SERVER_PORT:-8404}:8404"
    environment:
      - RESOURCE_SERVER_PORT=${RESOURCE_SERVER_PORT:-8404}
      - VITE_QUSD_TOKEN_ADDRESS=${QUSD_TOKEN_ADDRESS}
      - VITE_ESCROW_CONTRACT_ADDRESS=${ESCROW_CONTRACT_ADDRESS}
      - FACILITATOR_URL=http://x402-facilitator:8403
      - ACTUAL_ROBOT_URL=${ACTUAL_ROBOT_URL}
    networks:
      - paybot-network
    depends_on:
      x402-facilitator:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://0.0.0.0:8404/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    command: bun run start:resource

  # Web frontend
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      target: development
    container_name: paybot-web
    ports:
      - "${VITE_PORT:-5173}:5173"
    environment:
      - VITE_RPC_URL=http://localhost:${ANVIL_PORT:-8545}
      - VITE_CHAIN_ID=${ANVIL_CHAIN_ID:-31337}
      - VITE_QUSD_TOKEN_ADDRESS=${QUSD_TOKEN_ADDRESS}
      - VITE_ESCROW_CONTRACT_ADDRESS=${ESCROW_CONTRACT_ADDRESS}
      - VITE_FACILITATOR_URL=http://localhost:${X402_FACILITATOR_PORT:-8403}
      - VITE_BOT_SERVER_URL=http://localhost:${RESOURCE_SERVER_PORT:-8404}
      - VITE_BACKEND_URL=http://localhost:3000
      - VITE_ROBOT_CONTROL_URL=${VITE_ROBOT_CONTROL_URL}
      - VITE_ROBOT_PROVIDER_ADDRESS=${VITE_ROBOT_PROVIDER_ADDRESS}
      - VITE_ROBOT_BOT_ID=${VITE_BOT_ID:-bot-001}
      - VITE_ROBOT_BOT_NAME=${VITE_BOT_NAME:-PayBot Demo}
      - VITE_ROBOT_FULL_ACCESS_PRICE=100
      - VITE_DEFAULT_PAYMENT_TIMEOUT=3600
    networks:
      - paybot-network
    depends_on:
      - hardhat-node
      - x402-facilitator
      - resource-server
    volumes:
      - ./apps/web:/app/apps/web
      - ./packages:/app/packages
      - contract-exports:/app/apps/web/src/contracts:ro
      - /app/node_modules
      - /app/apps/web/node_modules
    stdin_open: true
    tty: true

networks:
  paybot-network:
    driver: bridge
    name: paybot-network

volumes:
  contracts-data:
    name: paybot-contracts-data
  contract-exports:
    name: paybot-contract-exports
